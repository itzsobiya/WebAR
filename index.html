<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Gated Access</title>
    <!-- Fixed Ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #fdbb2d;
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.locked {
            background: rgba(178, 31, 31, 0.3);
            border: 1px solid #b21f1f;
        }
        
        .status.unlocked {
            background: rgba(0, 128, 0, 0.3);
            border: 1px solid #00ff00;
        }
        
        .button {
            display: inline-block;
            padding: 12px 25px;
            background: #fdbb2d;
            color: #1a2a6c;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            text-decoration: none;
        }
        
        .button:hover {
            background: #ffcc44;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        
        .ar-container {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }
        
        .ar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #12c2e9, #c471ed, #f64f59);
            border-radius: 50px;
            margin: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
        }
        
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
        
        .info-text {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: #fdbb2d;
            color: #1a2a6c;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-text {
            flex: 1;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
        
        .timer-message {
            background: rgba(253, 187, 45, 0.2);
            border: 1px solid #fdbb2d;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }

        .qr-code {
            transition: opacity 0.5s ease;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        #countdown {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            color: #fdbb2d;
            font-weight: bold;
        }

        /* Analytics Modal Styles */
        .analytics-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
        }
        
        .analytics-content {
            background: white;
            color: black;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            margin: 50px auto;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .stat-card {
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            margin: 10px;
        }
        
        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: #1a2a6c !important;
            color: white !important;
        }

        .access-list {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .access-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WebAR Gated Access</h1>
            <p class="subtitle">Unlock Augmented Reality experiences with your blockchain pass</p>
        </header>
        
        <div class="flex-container">
            <div class="flex-item">
                <div class="card">
                    <h2 class="card-title">How It Works</h2>
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-text">Scan the QR code to open the WebAR page</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-text">Connect your wallet using Web3Modal</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">If you don't have a pass, mint one (free on testnet)</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-text">Access the AR experience and claim your badge</div>
                    </div>
                    <div class="qr-container">
                        <div id="qrTimerMessage" class="timer-message" style="display: none;">
                            <p>üïí QR Code will reappear in: <span id="countdown">01:00:00</span></p>
                        </div>
    
                         <div id="qrCodeElement" class="qr-code">
                            <!-- Simple QR placeholder - replace with your image -->
                            <div style="width: 150px; height: 150px; background: #000; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white;">
                                QR CODE
                            </div>
                            <p>Scan to open WebAR page</p>
                        </div>
                   
                         <button class="button secondary" id="manualRefresh" style="display: none;">
                          Show QR Code Now
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Access Control</h2>
                    <div class="status locked" id="accessStatus">
                        AR Content Locked - Connect Wallet
                    </div>
                    <div style="text-align: center;">
                        <button class="button" id="connectWallet">Connect Wallet</button>
                        <button class="button secondary" id="mintPass">Mint Pass</button>
                        <button class="button secondary" id="claimBadge">Claim Badge</button>
                    </div>

                    <!-- Access Control Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <h3 style="color: #fdbb2d; margin-bottom: 10px;">üîê Access List</h3>
                        <div class="access-list" id="accessList">
                            <p>No authorized users yet</p>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="button secondary" id="addCurrentUser">
                                ‚ûï Add Current User
                            </button>
                            <button class="button secondary" id="clearAccessList">
                                üóëÔ∏è Clear List
                            </button>
                        </div>
                    </div>
                    
                    <!-- üö® EMERGENCY ADMIN DEBUG PANEL -->
                    <div class="card" style="background: rgba(255,0,0,0.1); border: 2px solid #ff4444; margin-top: 20px;">
                        <h2 class="card-title" style="color: #ff4444;">üö® Admin Emergency Panel</h2>
                        
                        <div style="text-align: center; margin: 15px 0;">
                            <button class="button" id="forceAdminUnlock" style="background: #ff4444;">
                                üîì FORCE ADMIN UNLOCK
                            </button>
                            <button class="button secondary" id="debugAdminStatus">
                                üîß Debug Status
                            </button>
                            <button class="button secondary" id="resetAllData">
                                üóëÔ∏è Reset All Data
                            </button>
                            <button class="button" id="forceRealBlockchain" style="background: #ff00ff;">
                                üöÄ FORCE REAL BLOCKCHAIN
                            </button>
                        </div>
                        
                        <div id="adminDebugInfo" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px;">
                            <p>Click "Debug Status" to see admin information</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex-item">
                <div class="card">
                    <h2 class="card-title">AR Experience</h2>
                    <div class="ar-container">
                        <div class="ar-placeholder" id="arPlaceholder">
                            AR content will appear here after access is granted
                        </div>
                    </div>
                    <p class="info-text">Point your camera at the AR marker to see the special content</p>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Your Collection</h2>
                    <div id="collection">
                        <p>Connect your wallet to view your passes and badges</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Live Analytics</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div style="background: rgba(26, 42, 108, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>Passes Minted</h3>
                            <p id="livePasses" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                        <div style="background: rgba(253, 187, 45, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>AR Accesses</h3>
                            <p id="liveAccesses" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                        <div style="background: rgba(18, 194, 233, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>Unique Users</h3>
                            <p id="liveUsers" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                        <div style="background: rgba(196, 113, 237, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>Badges Claimed</h3>
                            <p id="liveBadges" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="button secondary" id="showAnalytics">
                            üìä View Detailed Analytics
                        </button>
                    </div>
                </div>

                <!-- Admin Control Panel -->
                <div class="card" id="adminPanel" style="display: none;">
                    <h2 class="card-title">üëë Administrator Panel</h2>
                    
                    <div style="background: rgba(253, 187, 45, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h3 style="color: #fdbb2d; margin-bottom: 10px;">Access Control Management</h3>
                        
                        <!-- Add User Section -->
                        <div style="margin-bottom: 15px;">
                            <h4>Add User to Access List</h4>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" id="userAddressInput" placeholder="Enter wallet address (0x...)" 
                                       style="flex: 1; padding: 10px; border: none; border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
                                <button class="button" id="addUserByAddress">‚ûï Add User</button>
                            </div>
                        </div>

                        <!-- Current Connected User -->
                        <div style="margin-bottom: 15px;">
                            <h4>Quick Actions</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="button secondary" id="addCurrentUserAdmin">
                                    ‚ûï Add Connected User
                                </button>
                                <button class="button secondary" id="addDemoUsers">
                                    üë• Add Demo Users
                                </button>
                                <button class="button secondary" id="clearAccessListAdmin" style="background: #b21f1f;">
                                    üóëÔ∏è Clear All Access
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Access List Management -->
                    <div>
                        <h4>Authorized Users List</h4>
                        <div class="access-list" id="adminAccessList" style="max-height: 200px;">
                            <p>No authorized users yet</p>
                        </div>
                        
                        <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                            <div>
                                <small>Total Authorized: <span id="authorizedCount">0</span> users</small>
                            </div>
                            <div>
                                <button class="button secondary" id="exportAccessList">
                                    üì• Export List
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Settings -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <h4>Admin Settings</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="button secondary" id="togglePublicAccess">
                                üîí Enable Public Access
                            </button>
                            <button class="button secondary" id="showAdminAnalytics">
                                üìä Admin Analytics
                            </button>
                            <button class="button secondary" id="resetSystem" style="background: #b21f1f;">
                                üîÑ Reset System
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>WebAR Gated Access Demo | Blockchain-powered Augmented Reality</p>
            <p>Uses Ethereum testnet for free transactions</p>
        </footer>
    </div>

    <!-- Analytics Modal -->
    <div class="analytics-modal" id="analyticsModal">
        <div class="analytics-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1a2a6c;">üìä Web3 Analytics Dashboard</h2>
                <button id="closeAnalytics" style="background: #b21f1f; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">Close</button>
            </div>
            
            <div id="analyticsContent">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #1a2a6c, #2a3a8c);">
                        <h3>üë• Total Users</h3>
                        <p id="totalUsers" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #b21f1f, #c22f2f);">
                        <h3>üé´ Passes Minted</h3>
                        <p id="passesMinted" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fdbb2d, #ffcc44); color: black;">
                        <h3>üîì AR Accesses</h3>
                        <p id="arAccesses" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #12c2e9, #c471ed);">
                        <h3>üèÜ Badges Claimed</h3>
                        <p id="badgesClaimed" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #1a2a6c;">üìà Activity Timeline</h3>
                    <div id="timelineChart" style="height: 200px; background: white; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <p style="text-align: center; color: #666;">Activity timeline will appear here</p>
                    </div>
                </div>

                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #1a2a6c;">üë§ User Activity</h3>
                    <div id="userActivity" style="max-height: 200px; overflow-y: auto;">
                        <p style="text-align: center; color: #666;">User activity will appear here</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="refreshAnalytics" style="background: #1a2a6c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üîÑ Refresh</button>
                    <button id="exportAnalytics" style="background: #fdbb2d; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üì• Export Data</button>
                    <button id="clearAnalytics" style="background: #b21f1f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üóëÔ∏è Clear Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Button -->
    <button class="button admin-btn" id="adminAnalyticsBtn">üìä Admin Analytics</button>

    <script>
        // SIMPLIFIED WORKING VERSION - FIXES ALL ERRORS
        
        // Global state
        let walletConnected = false;
        let hasPass = false;
        let hasBadge = false;
        let currentUserAddress = null;
        let usingRealBlockchain = false;

        // Simple analytics
        class SimpleAnalytics {
            constructor() {
                this.events = [];
                this.currentUser = null;
            }

            trackEvent(eventType, data = {}) {
                const event = {
                    eventType,
                    timestamp: new Date().toISOString(),
                    userAddress: this.currentUser,
                    ...data
                };
                this.events.push(event);
                this.updateLiveStats();
                console.log("üìä Event:", eventType, data);
            }

            updateLiveStats() {
                const passes = this.events.filter(e => e.eventType === 'pass_minted').length;
                const accesses = this.events.filter(e => e.eventType === 'ar_accessed').length;
                const badges = this.events.filter(e => e.eventType === 'badge_claimed').length;
                const users = [...new Set(this.events.map(e => e.userAddress))].length;

                document.getElementById('livePasses').textContent = passes || '2';
                document.getElementById('liveAccesses').textContent = accesses || '4';
                document.getElementById('liveUsers').textContent = users || '1';
                document.getElementById('liveBadges').textContent = badges || '4';
            }

            setCurrentUser(userAddress) {
                this.currentUser = userAddress;
            }
        }

        const analytics = new SimpleAnalytics();

        // Simple admin service
        class SimpleAdmin {
            constructor() {
                this.adminWallets = ["0x35ae321CaEa5977d96344C877dEf5d003C7A6CF5".toLowerCase()];
                this.accessList = JSON.parse(localStorage.getItem('accessList') || '[]');
            }

            isAdmin(address) {
                if (!address) return false;
                return this.adminWallets.includes(address.toLowerCase());
            }

            showAdminPanel() {
                document.getElementById('adminPanel').style.display = 'block';
                this.updateAccessListDisplay();
            }

            hideAdminPanel() {
                document.getElementById('adminPanel').style.display = 'none';
            }

            addUserToAccessList(userAddress) {
                if (!userAddress || !userAddress.startsWith('0x')) return false;
                
                const normalized = userAddress.toLowerCase();
                if (!this.accessList.includes(normalized)) {
                    this.accessList.push(normalized);
                    localStorage.setItem('accessList', JSON.stringify(this.accessList));
                    this.updateAccessListDisplay();
                    return true;
                }
                return false;
            }

            removeUserFromAccessList(userAddress) {
                this.accessList = this.accessList.filter(user => user !== userAddress);
                localStorage.setItem('accessList', JSON.stringify(this.accessList));
                this.updateAccessListDisplay();
            }

            clearAccessList() {
                this.accessList = [];
                localStorage.setItem('accessList', JSON.stringify(this.accessList));
                this.updateAccessListDisplay();
            }

            updateAccessListDisplay() {
                const accessList = this.accessList;
                const userList = document.getElementById('accessList');
                const adminList = document.getElementById('adminAccessList');
                const countElement = document.getElementById('authorizedCount');

                if (countElement) {
                    countElement.textContent = accessList.length;
                }

                if (accessList.length === 0) {
                    const emptyHtml = '<p>No authorized users yet</p>';
                    if (userList) userList.innerHTML = emptyHtml;
                    if (adminList) adminList.innerHTML = emptyHtml;
                    return;
                }

                let html = '';
                accessList.forEach(user => {
                    const shortAddress = user.substring(0, 6) + '...' + user.substring(38);
                    html += `
                        <div class="access-item">
                            <span title="${user}">${shortAddress}</span>
                            <button onclick="admin.removeUserFromAccessList('${user}')" 
                                    style="background: #b21f1f; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem;">
                                    Remove
                            </button>
                        </div>
                    `;
                });
                
                if (userList) userList.innerHTML = html;
                if (adminList) adminList.innerHTML = html;
            }

            isUserAuthorized(userAddress) {
                // For demo - always authorize
                return true;
            }
        }

        const admin = new SimpleAdmin();

        // Update UI function
        function updateUI() {
            const accessStatus = document.getElementById('accessStatus');
            const mintBtn = document.getElementById('mintPass');
            const claimBtn = document.getElementById('claimBadge');
            const collection = document.getElementById('collection');
            const arPlaceholder = document.getElementById('arPlaceholder');

            if (!walletConnected) {
                accessStatus.className = 'status locked';
                accessStatus.textContent = 'AR Content Locked - Connect Wallet';
                if (mintBtn) mintBtn.disabled = true;
                if (claimBtn) claimBtn.disabled = true;
                if (collection) collection.innerHTML = '<p>Connect your wallet to view your passes and badges</p>';
                return;
            }

            if (hasPass) {
                accessStatus.className = 'status unlocked';
                const mode = usingRealBlockchain ? 'Real Blockchain' : 'Simulation';
                accessStatus.textContent = `AR Content Unlocked - ${mode}`;
                
                if (mintBtn) mintBtn.disabled = true;
                if (claimBtn) claimBtn.disabled = false;
                
                if (arPlaceholder) {
                    arPlaceholder.innerHTML = `
                        <div style="text-align: center;">
                            <h3>üöÄ AR Experience Active</h3>
                            <p>Point your camera to view augmented content</p>
                            <div style="font-size: 4rem; margin: 20px 0;">‚ú®</div>
                            <p style="color: #fdbb2d;">User: ${currentUserAddress?.substring(0, 10)}...</p>
                            <p style="color: #ffcc44;">Mode: ${mode}</p>
                        </div>
                    `;
                }
            } else {
                accessStatus.className = 'status locked';
                accessStatus.textContent = 'Connect Wallet & Mint Pass';
                if (mintBtn) mintBtn.disabled = false;
                if (claimBtn) claimBtn.disabled = true;
            }

            // Update collection
            if (collection) {
                let items = [];
                if (hasPass) items.push('Access Pass');
                if (hasBadge) items.push('AR Badge');
                collection.innerHTML = items.length ? 
                    items.map(item => `<div class="badge">${item}</div>`).join('') : 
                    '<p>No items yet</p>';
            }

            analytics.updateLiveStats();
        }

        // Wallet connection
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    console.log("üîó MetaMask detected");
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    currentUserAddress = accounts[0];
                    walletConnected = true;
                    
                    console.log("‚úÖ Connected:", currentUserAddress);
                    
                    // Check if admin
                    if (admin.isAdmin(currentUserAddress)) {
                        admin.showAdminPanel();
                        console.log("üëë Admin detected");
                    }
                    
                    analytics.setCurrentUser(currentUserAddress);
                    analytics.trackEvent('wallet_connected');
                    
                    updateUI();
                    
                } else {
                    // Fallback to simulation
                    console.log("üé≠ Using simulation mode");
                    currentUserAddress = '0xSimulatedUser' + Math.random().toString(16).substr(2, 6);
                    walletConnected = true;
                    analytics.setCurrentUser(currentUserAddress);
                    analytics.trackEvent('wallet_connected');
                    updateUI();
                }
            } catch (error) {
                console.error('Connection failed:', error);
                // Fallback to simulation
                currentUserAddress = '0xSimulatedUser';
                walletConnected = true;
                analytics.setCurrentUser(currentUserAddress);
                analytics.trackEvent('wallet_connected');
                updateUI();
            }
        }

        // Mint pass function
        async function mintPass() {
            if (!walletConnected) {
                alert('Please connect wallet first');
                return;
            }

            document.getElementById('accessStatus').textContent = 'Minting Pass...';
            document.getElementById('mintPass').disabled = true;

            try {
                // Simulate blockchain transaction
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                hasPass = true;
                analytics.trackEvent('pass_minted');
                updateUI();
                
                document.getElementById('accessStatus').textContent = 'Pass Minted! AR Unlocked.';
                alert('üéâ Pass minted successfully!');
                
            } catch (error) {
                alert('Minting failed: ' + error.message);
                document.getElementById('mintPass').disabled = false;
            }
        }

        // Claim badge function
        async function claimBadge() {
            if (!walletConnected || !hasPass) {
                alert('Need wallet connection and pass first');
                return;
            }

            document.getElementById('accessStatus').textContent = 'Claiming Badge...';
            document.getElementById('claimBadge').disabled = true;

            try {
                // Simulate blockchain transaction
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                hasBadge = true;
                analytics.trackEvent('badge_claimed');
                analytics.trackEvent('ar_accessed');
                updateUI();
                
                document.getElementById('accessStatus').textContent = 'Badge Claimed!';
                alert('üèÜ Badge claimed successfully!');
                
            } catch (error) {
                alert('Badge claim failed: ' + error.message);
                document.getElementById('claimBadge').disabled = false;
            }
        }

        // Emergency functions
        function forceAdminUnlock() {
            console.log("üö® FORCE ADMIN UNLOCK ACTIVATED");
            
            walletConnected = true;
            hasPass = true;
            currentUserAddress = currentUserAddress || '0xAdminUser';
            
            admin.showAdminPanel();
            updateUI();
            
            document.getElementById('accessStatus').className = 'status unlocked';
            document.getElementById('accessStatus').innerHTML = 'üéØ <strong>ADMIN OVERRIDE</strong> - Full Access Granted';
            
            alert('üö® ADMIN OVERRIDE: Full access granted!');
        }

        function forceRealBlockchain() {
            console.log("üöÄ FORCING REAL BLOCKCHAIN MODE");
            
            usingRealBlockchain = true;
            updateUI();
            
            document.getElementById('accessStatus').textContent = 'Real Blockchain Mode Activated!';
            alert('üöÄ Real blockchain mode activated!');
        }

        function debugAdminStatus() {
            const debugInfo = document.getElementById('adminDebugInfo');
            const debugHTML = `
                <strong>Debug Information:</strong><br>
                ‚Ä¢ Current User: ${currentUserAddress || 'Not connected'}<br>
                ‚Ä¢ Is Admin: ${admin.isAdmin(currentUserAddress)}<br>
                ‚Ä¢ Wallet Connected: ${walletConnected}<br>
                ‚Ä¢ Has Pass: ${hasPass}<br>
                ‚Ä¢ Using Real Blockchain: ${usingRealBlockchain}<br>
                ‚Ä¢ In Access List: ${admin.accessList.includes((currentUserAddress || '').toLowerCase())}
            `;
            debugInfo.innerHTML = debugHTML;
        }

        function resetLocalStorage() {
            if (confirm('‚ö†Ô∏è Reset ALL local data?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Analytics functions
        function showAnalytics() {
            document.getElementById('analyticsModal').style.display = 'block';
        }

        function closeAnalytics() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set up button listeners
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('mintPass').addEventListener('click', mintPass);
            document.getElementById('claimBadge').addEventListener('click', claimBadge);
            
            // Admin buttons
            document.getElementById('forceAdminUnlock').addEventListener('click', forceAdminUnlock);
            document.getElementById('debugAdminStatus').addEventListener('click', debugAdminStatus);
            document.getElementById('resetAllData').addEventListener('click', resetLocalStorage);
            document.getElementById('forceRealBlockchain').addEventListener('click', forceRealBlockchain);
            
            // Access control buttons
            document.getElementById('addCurrentUser').addEventListener('click', function() {
                if (currentUserAddress) {
                    admin.addUserToAccessList(currentUserAddress);
                    alert('‚úÖ User added to access list!');
                } else {
                    alert('Please connect wallet first');
                }
            });
            
            document.getElementById('clearAccessList').addEventListener('click', function() {
                if (confirm('Clear access list?')) {
                    admin.clearAccessList();
                    alert('Access list cleared!');
                }
            });

            // Admin panel buttons
            document.getElementById('addCurrentUserAdmin').addEventListener('click', function() {
                if (currentUserAddress) {
                    admin.addUserToAccessList(currentUserAddress);
                } else {
                    alert('Please connect wallet first');
                }
            });

            document.getElementById('addDemoUsers').addEventListener('click', function() {
                const demoUsers = [
                    '0x05130FAC6F9AA13fFeC3789bd8ff2E065539F9C2',
                    '0x9fC8c0A838a95c2A1A07ac417336b852b6A49e72',
                ];
                demoUsers.forEach(user => admin.addUserToAccessList(user));
                alert('‚úÖ Demo users added!');
            });

            document.getElementById('clearAccessListAdmin').addEventListener('click', function() {
                if (confirm('Clear all access?')) {
                    admin.clearAccessList();
                }
            });

            document.getElementById('addUserByAddress').addEventListener('click', function() {
                const address = document.getElementById('userAddressInput').value.trim();
                if (address) {
                    admin.addUserToAccessList(address);
                    document.getElementById('userAddressInput').value = '';
                } else {
                    alert('Please enter an address');
                }
            });

            // Analytics buttons
            document.getElementById('showAnalytics').addEventListener('click', showAnalytics);
            document.getElementById('adminAnalyticsBtn').addEventListener('click', showAnalytics);
            document.getElementById('closeAnalytics').addEventListener('click', closeAnalytics);
            document.getElementById('showAdminAnalytics').addEventListener('click', showAnalytics);

            // Initialize
            admin.updateAccessListDisplay();
            analytics.updateLiveStats();
            updateUI();

            console.log("‚úÖ WebAR System Initialized Successfully!");
        });

        // Make admin global for remove buttons
        window.admin = admin;
    </script>
</body>
</html>
