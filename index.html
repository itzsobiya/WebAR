<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR Gated Access</title>
    <!-- Fixed Ethers.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- A-Frame and AR.js for marker scanning -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #fdbb2d;
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.locked {
            background: rgba(178, 31, 31, 0.3);
            border: 1px solid #b21f1f;
        }
        
        .status.unlocked {
            background: rgba(0, 128, 0, 0.3);
            border: 1px solid #00ff00;
        }
        
        .button {
            display: inline-block;
            padding: 12px 25px;
            background: #fdbb2d;
            color: #1a2a6c;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            text-decoration: none;
        }
        
        .button:hover {
            background: #ffcc44;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        
        .ar-container {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }
        
        .ar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #12c2e9, #c471ed, #f64f59);
            border-radius: 50px;
            margin: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
        }
        
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
        
        .info-text {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: #fdbb2d;
            color: #1a2a6c;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step-text {
            flex: 1;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
        
        .timer-message {
            background: rgba(253, 187, 45, 0.2);
            border: 1px solid #fdbb2d;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }

        .qr-code {
            transition: opacity 0.5s ease;
        }

        .hidden {
            display: none !important;
        }

        #countdown {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            color: #fdbb2d;
            font-weight: bold;
        }

        /* AR Scanner Styles */
        .ar-scene-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .ar-scene-container a-scene {
            width: 100%;
            height: 100%;
        }
        
        .ar-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            text-align: center;
            z-index: 1000;
        }
        
        .ar-instructions {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: rgba(0,0,0,0.9);
            color: white;
            text-align: center;
            z-index: 1000;
        }
        
        .ar-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1001;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
        }

        .marker-info {
            background: rgba(253, 187, 45, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .marker-image {
            width: 150px;
            height: 150px;
            background: white;
            margin: 0 auto 15px;
            padding: 10px;
            border-radius: 5px;
        }

        /* Analytics Modal Styles */
        .analytics-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
        }
        
        .analytics-content {
            background: white;
            color: black;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            margin: 50px auto;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .stat-card {
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            margin: 10px;
        }
        
        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: #1a2a6c !important;
            color: white !important;
        }

        .access-list {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .access-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* New AR Controls */
        .ar-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        /* In your <style> section, add this: */
#timelineChart {
    height: 200px;
    background: white;
    padding: 15px;
    border-radius: 5px;
    margin-top: 10px;
    overflow-y: auto; /* Make it scrollable */
}

/* Add this for the timeline items */
#timelineChart > div {
    margin-bottom: 8px; /* Space between items */
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
    clear: both; /* Prevent overlap */
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WebAR Gated Access</h1>
            <p class="subtitle">Unlock Augmented Reality experiences with your blockchain pass</p>
        </header>
        
        <div class="flex-container">
            <div class="flex-item">
                <div class="card">
                    <h2 class="card-title">How It Works</h2>
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-text">Connect your wallet using Web3Modal</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-text">Mint a pass (free on testnet)</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">Claim your AR badge</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-text">Scan Hiro marker with camera to view AR</div>
                    </div>
                    
                    <!-- Marker Information -->
                    <div class="marker-info">
                        <h4 style="color: #fdbb2d; margin-bottom: 10px;">üéØ Hiro Marker</h4>
                        <p>Use this marker for AR scanning:</p>
                        <div class="marker-image">
                            <!-- Simple Hiro marker representation -->
                            <div style="width: 100%; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                HIRO MARKER
                            </div>
                        </div>
                        <p><strong>Download:</strong> 
                            <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" 
                               target="_blank" 
                               style="color: #4CC3D9; font-weight: bold; text-decoration: none;">
                               üìÑ Click Here
                            </a>
                        </p>
                        <p style="font-size: 0.9rem; margin-top: 10px; color: #ccc;">
                            Display on another screen or print it
                        </p>
                    </div>
                </div>  
                <div class="card">
                    <h2 class="card-title">Access Control</h2>
                    <div class="status locked" id="accessStatus">
                        AR Content Locked - Connect Wallet
                    </div>
                    <div style="text-align: center;">
                        <button class="button" id="connectWallet">Connect Wallet</button>
                        <button class="button secondary" id="mintPass" disabled>Mint Pass</button>
                        <button class="button secondary" id="claimBadge" disabled>Claim Badge</button>
                        <button class="button" id="startAR" disabled style="background: #4CC3D9;">Start AR Scanner</button>
                    </div>

                    <!-- Access Control Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <h3 style="color: #fdbb2d; margin-bottom: 10px;">üîê Access List</h3>
                        <div class="access-list" id="accessList">
                            <p>No authorized users yet</p>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="button secondary" id="addCurrentUser">
                                ‚ûï Add Current User
                            </button>
                            <button class="button secondary" id="clearAccessList">
                                üóëÔ∏è Clear List
                            </button>
                        </div>
                    </div>
                    
                    <!-- üö® EMERGENCY ADMIN DEBUG PANEL -->
                    <div class="card" style="background: rgba(255,0,0,0.1); border: 2px solid #ff4444; margin-top: 20px;">
                        <h2 class="card-title" style="color: #ff4444;">üö® Admin Emergency Panel</h2>
                        
                        <div style="text-align: center; margin: 15px 0;">
                            <button class="button" id="forceAdminUnlock" style="background: #ff4444;">
                                üîì FORCE ADMIN UNLOCK
                            </button>
                            <button class="button secondary" id="debugAdminStatus">
                                üîß Debug Status
                            </button>
                            <button class="button secondary" id="resetAllData">
                                üóëÔ∏è Reset All Data
                            </button>
                            <button class="button" id="forceRealBlockchain" style="background: #ff00ff;">
                                üöÄ FORCE REAL BLOCKCHAIN
                            </button>
                        </div>
                        
                        <div id="adminDebugInfo" style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px;">
                            <p>Click "Debug Status" to see admin information</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex-item">
                <div class="card">
                    <h2 class="card-title">AR Experience</h2>
                    <div class="ar-container" id="arContainer">
                        <div class="ar-placeholder" id="arPlaceholder">
                            <div style="text-align: center;">
                                <h3>üîí AR Scanner</h3>
                                <p>Complete these steps to unlock:</p>
                                <div style="margin: 15px 0;">
                                    <p style="color: #b21f1f;">‚úì Connect Wallet</p>
                                    <p style="color: #b21f1f;">‚úì Mint Pass</p>
                                    <p style="color: #b21f1f;">‚úì Claim Badge</p>
                                </div>
                                <p style="color: #fdbb2d;">Then click "Start AR Scanner"</p>
                            </div>
                        </div>
                        
                        <!-- AR Scene will be inserted here -->
                        <div id="arSceneWrapper" class="hidden">
                            <div class="ar-header">
                                <h3>üéì SECAB Campus AR Tour</h3>
                                <p id="arStatus">Camera permission needed...</p>
                            </div>
                            <div class="ar-loading" id="arLoading">
                                <h3>üì± Loading AR Experience...</h3>
                                <p>Please allow camera access when prompted</p>
                                <div style="margin-top: 15px;">
                                    <div style="width: 30px; height: 30px; border: 3px solid #fdbb2d; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                                </div>
                            </div>
                            <div class="ar-instructions" id="arInstructions">
                                <h4>üéØ How to Use:</h4>
                                <p style="margin: 5px 0; font-size: 14px;">1. Point camera at Hiro marker</p>
                                <p style="margin: 5px 0; font-size: 14px;">2. Hold steady for better tracking</p>
                                <div class="ar-controls">
                                    <button class="button" id="stopAR" style="padding: 8px 15px; background: #b21f1f;">Stop AR</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="info-text">When unlocked, point your camera at the Hiro marker to see SECAB Campus AR</p>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Your Collection</h2>
                    <div id="collection">
                        <p>Connect your wallet to view your passes and badges</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Live Analytics</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div style="background: rgba(26, 42, 108, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>Passes Minted</h3>
                            <p id="livePasses" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                        <div style="background: rgba(253, 187, 45, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>AR Accesses</h3>
                            <p id="liveAccesses" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                        <div style="background: rgba(18, 194, 233, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>Unique Users</h3>
                            <p id="liveUsers" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                        <div style="background: rgba(196, 113, 237, 0.3); padding: 15px; border-radius: 10px;">
                            <h3>Badges Claimed</h3>
                            <p id="liveBadges" style="font-size: 2rem; font-weight: bold;">0</p>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="button secondary" id="showAnalytics">
                            üìä View Detailed Analytics
                        </button>
                    </div>
                </div>

                <!-- Admin Control Panel -->
                <div class="card" id="adminPanel" style="display: none;">
                    <h2 class="card-title">üëë Administrator Panel</h2>
                    
                    <div style="background: rgba(253, 187, 45, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h3 style="color: #fdbb2d; margin-bottom: 10px;">Access Control Management</h3>
                        
                        <!-- Add User Section -->
                        <div style="margin-bottom: 15px;">
                            <h4>Add User to Access List</h4>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <input type="text" id="userAddressInput" placeholder="Enter wallet address (0x...)" 
                                       style="flex: 1; padding: 10px; border: none; border-radius: 5px; background: rgba(255,255,255,0.1); color: white;">
                                <button class="button" id="addUserByAddress">‚ûï Add User</button>
                            </div>
                        </div>

                        <!-- Current Connected User -->
                        <div style="margin-bottom: 15px;">
                            <h4>Quick Actions</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="button secondary" id="addCurrentUserAdmin">
                                    ‚ûï Add Connected User
                                </button>
                                <button class="button secondary" id="addDemoUsers">
                                    üë• Add Demo Users
                                </button>
                                <button class="button secondary" id="clearAccessListAdmin" style="background: #b21f1f;">
                                    üóëÔ∏è Clear All Access
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Access List Management -->
                    <div>
                        <h4>Authorized Users List</h4>
                        <div class="access-list" id="adminAccessList" style="max-height: 200px;">
                            <p>No authorized users yet</p>
                        </div>
                        
                        <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                            <div>
                                <small>Total Authorized: <span id="authorizedCount">0</span> users</small>
                            </div>
                            <div>
                                <button class="button secondary" id="exportAccessList">
                                    üì• Export List
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Settings -->
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <h4>Admin Settings</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="button secondary" id="togglePublicAccess">
                                üîí Enable Public Access
                            </button>
                            <button class="button secondary" id="showAdminAnalytics">
                                üìä Admin Analytics
                            </button>
                            <button class="button secondary" id="resetSystem" style="background: #b21f1f;">
                                üîÑ Reset System
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>WebAR Gated Access | Blockchain-powered Augmented Reality</p>
            <p>Uses Ethereum testnet for free transactions | Scan Hiro marker for AR content</p>
        </footer>
    </div>

    <!-- Analytics Modal -->
    <div class="analytics-modal" id="analyticsModal">
        <div class="analytics-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1a2a6c;">üìä Web3 Analytics Dashboard</h2>
                <button id="closeAnalytics" style="background: #b21f1f; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">Close</button>
            </div>
            
            <div id="analyticsContent">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #1a2a6c, #2a3a8c);">
                        <h3>üë• Total Users</h3>
                        <p id="totalUsers" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #b21f1f, #c22f2f);">
                        <h3>üé´ Passes Minted</h3>
                        <p id="passesMinted" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fdbb2d, #ffcc44); color: black;">
                        <h3>üîì AR Accesses</h3>
                        <p id="arAccesses" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #12c2e9, #c471ed);">
                        <h3>üèÜ Badges Claimed</h3>
                        <p id="badgesClaimed" style="font-size: 2rem; font-weight: bold; margin: 10px 0;">0</p>
                    </div>
                </div>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #1a2a6c;">üìà Activity Timeline</h3>
                    <div id="timelineChart" style="height: 200px; background: white; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <p style="text-align: center; color: #666;">Activity timeline will appear here</p>
                    </div>
                </div>

                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #1a2a6c;">üë§ User Activity</h3>
                    <div id="userActivity" style="max-height: 200px; overflow-y: auto;">
                        <p style="text-align: center; color: #666;">User activity will appear here</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="refreshAnalytics" style="background: #1a2a6c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üîÑ Refresh</button>
                    <button id="exportAnalytics" style="background: #fdbb2d; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üì• Export Data</button>
                    <button id="clearAnalytics" style="background: #b21f1f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üóëÔ∏è Clear Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Button -->
    <button class="button admin-btn" id="adminAnalyticsBtn">üìä Admin Analytics</button>

    <script>
        // SIMPLIFIED WORKING VERSION - WITH AR INTEGRATION
        
        // Global state
        let walletConnected = false;
        let hasPass = false;
        let hasBadge = false;
        let currentUserAddress = null;
        let usingRealBlockchain = false;
        let arActive = false;

        // ==================== REAL BLOCKCHAIN CONFIGURATION ====================
// REAL CONTRACT CONFIGURATION - UPDATE THESE WITH YOUR DEPLOYED CONTRACT ADDRESSES!
const CONTRACT_CONFIG = {
    sepolia: {
        passContract: "0x1fcafe51ce127e61399e956baebe12f35b912fbc",    // REPLACE WITH YOUR AccessPass address
        badgeContract: "0x00e3eb1e78711631a323088552f8bb82b90fc353",       // REPLACE WITH YOUR ARBadge address
        rpcUrl: "https://sepolia.infura.io/v3/ed04afdd04fe4eab8c8a39bfc4f38df7" // Get from infura.io
    }
};

// ABI for AccessPass contract (must match your deployed contract)
const PASS_CONTRACT_ABI =[
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721IncorrectOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721InsufficientApproval",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOperator",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC721InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721NonexistentToken",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "MAX_SUPPLY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "MINT_PRICE",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasMinted",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "hasPass",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "mintPass",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "mintingEnabled",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "toggleMinting",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "withdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]

// ABI for ARBadge contract
const BADGE_CONTRACT_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_accessPassAddress",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721IncorrectOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721InsufficientApproval",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "approver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidApprover",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOperator",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "ERC721InvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			}
		],
		"name": "ERC721InvalidReceiver",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			}
		],
		"name": "ERC721InvalidSender",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ERC721NonexistentToken",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "approved",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Approval",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "ApprovalForAll",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "accessPassContract",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "approve",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "balanceOf",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "checkBadgeStatus",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "claimBadge",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "getApproved",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "hasBadge",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			}
		],
		"name": "isApprovedForAll",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "ownerOf",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "data",
				"type": "bytes"
			}
		],
		"name": "safeTransferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_newAddress",
				"type": "address"
			}
		],
		"name": "setAccessPassContract",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "operator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "approved",
				"type": "bool"
			}
		],
		"name": "setApprovalForAll",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bytes4",
				"name": "interfaceId",
				"type": "bytes4"
			}
		],
		"name": "supportsInterface",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "symbol",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "tokenURI",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "tokenId",
				"type": "uint256"
			}
		],
		"name": "transferFrom",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]
// Contract Manager Class
class ContractManager {
    constructor() {
        this.provider = null;
        this.signer = null;
        this.passContract = null;
        this.badgeContract = null;
        this.initialized = false;
    }
    
    async initialize() {
        if (!window.ethereum) {
            console.warn("No web3 wallet found. Using simulation mode.");
            return false;
        }
        
        try {
            // Request accounts first
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            // Create provider and signer
            this.provider = new ethers.providers.Web3Provider(window.ethereum);
            this.signer = this.provider.getSigner();
            
            // Get network
            const network = await this.provider.getNetwork();
            console.log("Connected to network:", network.name, network.chainId);
            
            // Check if we're on Sepolia
            if (network.chainId !== 11155111 && network.chainId !== 1) {
                console.warn("Not on Sepolia. Using simulation mode.");
                return false;
            }
            
            // Initialize contracts
            await this.initializeContracts();
            
            this.initialized = true;
            console.log("‚úÖ Contract manager initialized");
            return true;
              } catch (error) {
            console.error("Failed to initialize contracts:", error);
            return false;
        }
    }
    
    async initializeContracts() {
        const config = CONTRACT_CONFIG.sepolia;
        
        // Check if contracts are configured
        if (!config.passContract || config.passContract.includes('YOUR')) {
            throw new Error('Contract addresses not configured. Please update CONTRACT_CONFIG.');
        }
        
        // Initialize pass contract
        this.passContract = new ethers.Contract(
            config.passContract,
            PASS_CONTRACT_ABI,
            this.signer 
        );
        
        // Initialize badge contract
        this.badgeContract = new ethers.Contract(
            config.badgeContract,
            BADGE_CONTRACT_ABI,
            this.signer
        );
        
        console.log("Contracts initialized successfully");
    }
    
    async checkUserStatus(userAddress) {
        if (!this.initialized || !userAddress) {
            return { hasPass: false, hasBadge: false };
        }
        
        try {
            const [passBalance, hasBadge] = await Promise.all([
                this.passContract.balanceOf(userAddress),
                 this.badgeContract.hasBadge(userAddress)
            ]);
            
            return {
                hasPass: passBalance.gt(0), // greater than 0
                hasBadge: hasBadge,
                passCount: passBalance.toNumber()
            };
            
        } catch (error) {
            console.warn("Error checking user status:", error);
            return { hasPass: false, hasBadge: false };
        }
    }
}
      const contractManager = new ContractManager();
         class ARManager {
            constructor() {
                this.scene = null;
                this.markerDetected = false;
                this.cameraActive = false;
            }

            createARScene() {
                const container = document.getElementById('arContainer');
                const placeholder = document.getElementById('arPlaceholder');
                const wrapper = document.getElementById('arSceneWrapper');
                
                // Show AR wrapper
                placeholder.classList.add('hidden');
                wrapper.classList.remove('hidden');
                
                // Hide loading after a moment
                const loading = document.getElementById('arLoading');
                setTimeout(() => {
                    if (loading) loading.style.display = 'none';
                }, 1500);
                
                // Create AR scene HTML
                const sceneHTML = `
                            <a-scene 
                             embedded 
                             arjs="sourceType: webcam; debugUIEnabled: false;"
                             vr-mode-ui="enabled: false"
                             renderer="antialias: true;"
                            style="width: 100%; height: 100%;"
                            >
              <a-assets>
            <a-asset-item id="castleModel" src="models/castle_of_loarre.glb"></a-asset-item>
        </a-assets>
        
        <a-marker preset="hiro" id="hiro-marker">
            <a-entity
                gltf-model="#castleModel"
                position="0 0.5 0"
                scale="0.02 0.02 0.02"
                rotation="0 180 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 30000"
                gltf-model-loaded="console.log('Castle model loaded!')"
                gltf-model-error="console.error('Failed to load castle model:', event.detail)"
            ></a-entity>
            
            <a-text 
                value="Castle of Loarre" 
                position="0 4.0 0" 
                align="center" 
                color="#FFD700"
                scale="2 2 2"
            ></a-text>
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>
`;
                
                // Add scene to wrapper
                wrapper.insertAdjacentHTML('beforeend', sceneHTML);
                
                // Get the scene element
                this.scene = wrapper.querySelector('a-scene');
                
                // Set up event listeners
                if (this.scene) {
                    this.scene.addEventListener('loaded', () => {
                        console.log('‚úÖ AR Scene loaded');
                        document.getElementById('arStatus').textContent = 'Ready - Point camera at Hiro marker';
                        analytics.trackEvent('ar_scene_loaded');
                    });
                    
                    // Marker detection events
                    setTimeout(() => {
                        const marker = document.getElementById('hiro-marker');
                        if (marker) {
                            marker.addEventListener('markerFound', () => {
                                this.markerDetected = true;
                                document.getElementById('arStatus').innerHTML = '‚úÖ <span style="color:#4CC3D9;">Marker Found! AR Active</span>';
                                document.querySelector('.ar-header h3').innerHTML = 'üéì SECAB Campus Visible!';
                                analytics.trackEvent('marker_detected');
                            });
                            
                            marker.addEventListener('markerLost', () => {
                                this.markerDetected = false;
                                document.getElementById('arStatus').textContent = 'Searching for Hiro marker...';
                                document.querySelector('.ar-header h3').innerHTML = 'üéì SECAB Campus AR Tour';
                            });
                        }
                    }, 1000);
                }
                
                arActive = true;
                return true;
            }

            stopARScene() {
                const placeholder = document.getElementById('arPlaceholder');
                const wrapper = document.getElementById('arSceneWrapper');
                const scene = wrapper.querySelector('a-scene');
                
                if (scene) {
                    scene.parentNode.removeChild(scene);
                }
                
                // Reset wrapper
                wrapper.classList.add('hidden');
                placeholder.classList.remove('hidden');
                
                // Reset UI
                document.getElementById('arLoading').style.display = 'block';
                
                this.scene = null;
                this.markerDetected = false;
                arActive = false;
                
                analytics.trackEvent('ar_scene_stopped');
                console.log('‚èπÔ∏è AR Scene stopped');
            }

         async checkCameraPermission() {
                return new Promise((resolve) => {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(() => {
                                console.log("‚úÖ Camera access granted");
                                this.cameraActive = true;
                                resolve(true);
                            })
                            .catch((error) => {
                                console.log("‚ö†Ô∏è Camera not accessible:", error.name);
                                alert('Camera access is required for AR scanning. Please enable camera permissions.');
                                resolve(false);
                            });
                    } else {
                        alert('Camera API not supported in this browser.');
                        resolve(false);
                    }
                });
            }
       }
        const arManager = new ARManager();

        class SimpleAnalytics {
        constructor() {
        this.events = JSON.parse(localStorage.getItem('ar_analytics_events') || '[]');
        this.currentUser = null;
        this.stats = {
            passesMinted: 0,
            arAccesses: 0,
            uniqueUsers: 0,
            badgesClaimed: 0
        };
        this.loadStats();
        this.updateLiveStats();
        this.updateUserActivity(); // Initialize display
        this.updateUserActivity(); // Initialize user activity
    }

    loadStats() {
        // Load saved stats or calculate from events
        const savedStats = JSON.parse(localStorage.getItem('ar_analytics_stats') || 'null');
        if (savedStats) {
            this.stats = savedStats;
        } else {
            this.calculateStats();
        }
    }

    saveStats() {
        localStorage.setItem('ar_analytics_stats', JSON.stringify(this.stats));
    }

    calculateStats() {
        this.stats.passesMinted = this.events.filter(e => e.eventType === 'pass_minted').length;
        this.stats.arAccesses = this.events.filter(e => e.eventType === 'ar_accessed').length;
        this.stats.badgesClaimed = this.events.filter(e => e.eventType === 'badge_claimed').length;
        
        const uniqueUsers = [...new Set(this.events.map(e => e.userAddress).filter(Boolean))];
        this.stats.uniqueUsers = uniqueUsers.length;
    }

    trackEvent(eventType, data = {}) {
        const event = {
            eventType,
            timestamp: new Date().toISOString(),
            userAddress: this.currentUser,
            ...data
        };
        
        this.events.push(event);
        localStorage.setItem('ar_analytics_events', JSON.stringify(this.events));
        
        // Update stats based on event
        this.updateStats(eventType);
        this.updateLiveStats();
        this.updateUserActivity();
        
        console.log("üìä Event:", eventType, data);
        return event;
    }

    updateStats(eventType) {
        switch(eventType) {
            case 'pass_minted':
                this.stats.passesMinted++;
                break;
            case 'ar_accessed':
                this.stats.arAccesses++;
                break;
            case 'badge_claimed':
                this.stats.badgesClaimed++;
                break;
        }
        
        // Recalculate unique users
        const uniqueUsers = [...new Set(this.events.map(e => e.userAddress).filter(Boolean))];
        this.stats.uniqueUsers = uniqueUsers.length;
        
        this.saveStats();

        this.updateTimeline();
        this.updateUserActivity();
    }

    updateLiveStats() {
        // Update live display with REAL data
        document.getElementById('livePasses').textContent = this.stats.passesMinted;
        document.getElementById('liveAccesses').textContent = this.stats.arAccesses;
        document.getElementById('liveUsers').textContent = this.stats.uniqueUsers;
        document.getElementById('liveBadges').textContent = this.stats.badgesClaimed;
        
        // Update analytics modal if it exists
        if (document.getElementById('totalUsers')) {
            document.getElementById('totalUsers').textContent = this.stats.uniqueUsers;
            document.getElementById('passesMinted').textContent = this.stats.passesMinted;
            document.getElementById('arAccesses').textContent = this.stats.arAccesses;
            document.getElementById('badgesClaimed').textContent = this.stats.badgesClaimed;
                   
            this.updateTimeline();
            this.updateUserActivity(); 
        }
    }
    updateTimeline() {
        const timeline = document.getElementById('timelineChart');
        if (!timeline) return;
        
        const recentEvents = this.getRecentActivity(8);
        
        if (recentEvents.length === 0) {
            timeline.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No recent activity</p>';
            return;
        }
        
        const html = recentEvents.map((event, index) => {
            const time = new Date(event.timestamp);
            const shortAddress = event.userAddress ? 
                `${event.userAddress.substring(0, 6)}...${event.userAddress.substring(38)}` : 
                 'Unknown';
             const formattedTime = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const formattedDate = time.toLocaleDateString();
            
            // Different colors for different events
            let color = '#1a2a6c'; // Default blue
            if (event.eventType === 'pass_minted') color = '#b21f1f'; // Red
            if (event.eventType === 'badge_claimed') color = '#fdbb2d'; // Yellow
            if (event.eventType === 'ar_accessed') color = '#4CC3D9'; // Cyan
            
            return `
                <div style="padding: 8px 0; border-bottom: 1px solid #eee; position: relative;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 3px;">
                        <div style="width: 8px; height: 8px; background-color: ${color}; border-radius: 50%;"></div>
                        <span style="font-weight: bold; color: ${color}; font-size: 0.9rem;">
                          ${this.formatEventType(event.eventType)}
                        </span>
                        <span style="margin-left: auto; font-size: 0.8rem; color: #888;">
                            ${formattedTime}
                        </span>
                    </div>
                    <div style="font-size: 0.75rem; color: #666; padding-left: 18px;">
                        <span style="background: #f0f0f0; padding: 1px 6px; border-radius: 3px; margin-right: 5px;">
                            üë§ ${shortAddress}
                        </span>
                        <span style="font-size: 0.7rem; color: #999;">
                            ${formattedDate}
                        </span>
                    </div>
                </div>
            `;   
        }).join('');
        
        timeline.innerHTML = html;
    }
        
    updateUserActivity() {
        const container = document.getElementById('userActivity');
        if (!container) return;
        
        // Group events by user
        const userEvents = {};
        this.events.forEach(event => {
            if (!event.userAddress) return;
            
            if (!userEvents[event.userAddress]) {
                userEvents[event.userAddress] = {
                    events: [],
                    lastActivity: null
                };
            }
            
            userEvents[event.userAddress].events.push(event);
            const eventTime = new Date(event.timestamp);
            if (!userEvents[event.userAddress].lastActivity || 
                eventTime > userEvents[event.userAddress].lastActivity) {
                userEvents[event.userAddress].lastActivity = eventTime;
            }
        });
        
        // Convert to array and sort by last activity
        const usersArray = Object.entries(userEvents)
            .map(([address, data]) => ({
                address,
                eventCount: data.events.length,
                lastActivity: data.lastActivity,
                eventTypes: [...new Set(data.events.map(e => e.eventType))]
            }))
            .sort((a, b) => b.lastActivity - a.lastActivity)
            .slice(0, 10); // Show top 10
             if (usersArray.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666;">No user activity yet</p>';
            return;
        }
        
        // Generate HTML
        const html = usersArray.map(user => `
            <div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 5px; border-left: 4px solid #1a2a6c;">
                <div style="font-weight: bold; color: #1a2a6c; margin-bottom: 3px;">
                    ${user.address.substring(0, 8)}...${user.address.substring(38)}
                </div>
                <div style="font-size: 12px; color: #666;">
                    <span style="color: #4CAF50;">${user.eventCount} events</span> ‚Ä¢ 
                    Last: ${this.formatEventType(user.eventTypes[0] || 'None')}
                </div>
                <div style="font-size: 11px; color: #999; margin-top: 3px;">
                    ${user.lastActivity ? user.lastActivity.toLocaleTimeString() : 'Unknown'}
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    formatEventType(type) {
        const map = {
            'wallet_connected': 'üëõ Wallet',
            'pass_minted': 'üé´ Pass Minted',
            'badge_claimed': 'üèÜ Badge Claimed',
            'ar_accessed': 'üîì AR Accessed'
        };
        return map[type] || type;
    }

    setCurrentUser(userAddress) {
        this.currentUser = userAddress;
        localStorage.setItem('ar_content_user',userAddress);
    }
     getRecentActivity(limit = 10) {
        return this.events
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, limit);
    }
}    

        const analytics = new SimpleAnalytics();
        // Add this function to your SimpleAnalytics class or as a separate function
    function updateTimeline() {
        const timeline = document.getElementById('timelineChart');
        if (!timeline) return;
    
    const recentEvents = analytics.getRecentActivity(8);

    if (recentEvents.lenght === 0){
        timeline.innerHTML = '<p style="text-align: center; color: #666; padding:20px;">No recent activity</p>';
        return;
    }
    const html = recentEvents.map((event, index) => {
        const time = new Date(event.timestamp);
        const shortAddress = event.userAddress ? 
            `${event.userAddress.substring(0, 6)}...${event.userAddress.substring(38)}` : 
            'Unknown';

            const formattedTime = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const formattedDate = time.toLocaleDateString();
            
            // Different colors for different events
            let color = '#1a2a6c'; // Default blue
            if (event.eventType === 'pass_minted') color = '#b21f1f'; // Red
            if (event.eventType === 'badge_claimed') color = '#fdbb2d'; // Yellow
            if (event.eventType === 'ar_accessed') color = '#4CC3D9'; // Cyan
        
        // ADD UNIQUE ID AND CLEAR STYLING
        return `
             <div style="padding: 8px 0; border-bottom: 1px solid #eee; position: relative;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 3px;">
                        <div style="width: 8px; height: 8px; background-color: ${color}; border-radius: 50%;"></div>
                        <span style="font-weight: bold; color: ${color}; font-size: 0.9rem;">
                            ${this.formatEventType(event.eventType)}
                        </span>
                        <span style="margin-left: auto; font-size: 0.8rem; color: #888;">
                            ${formattedTime}
                        </span>
                    </div>
                    <div style="font-size: 0.75rem; color: #666; padding-left: 18px;">
                        <span style="background: #f0f0f0; padding: 1px 6px; border-radius: 3px; margin-right: 5px;">
                            üë§ ${shortAddress}
                        </span>
                        <span style="font-size: 0.7rem; color: #999;">
                            ${formattedDate}
                        </span>
                    </div>
                </div>
            `;   
    }).join('');
    
    timeline.innerHTML = html;
}

        // Simple admin service
        class SimpleAdmin {
            constructor() {
                this.adminWallets = ["0x35ae321CaEa5977d96344C877dEf5d003C7A6CF5".toLowerCase()];
                this.accessList = JSON.parse(localStorage.getItem('accessList') || '[]');
            }

            isAdmin(address) {
                if (!address) return false;
                return this.adminWallets.includes(address.toLowerCase());
            }

            showAdminPanel() {
                document.getElementById('adminPanel').style.display = 'block';
                this.updateAccessListDisplay();
            }

            hideAdminPanel() {
                document.getElementById('adminPanel').style.display = 'none';
            }

            addUserToAccessList(userAddress) {
                if (!userAddress || !userAddress.startsWith('0x')) return false;
                
                const normalized = userAddress.toLowerCase();
                if (!this.accessList.includes(normalized)) {
                    this.accessList.push(normalized);
                    localStorage.setItem('accessList', JSON.stringify(this.accessList));
                    this.updateAccessListDisplay();
                    return true;
                }
                return false;
            }

            removeUserFromAccessList(userAddress) {
                this.accessList = this.accessList.filter(user => user !== userAddress);
                localStorage.setItem('accessList', JSON.stringify(this.accessList));
                this.updateAccessListDisplay();
            }

            clearAccessList() {
                this.accessList = [];
                localStorage.setItem('accessList', JSON.stringify(this.accessList));
                this.updateAccessListDisplay();
            }

            updateAccessListDisplay() {
                const accessList = this.accessList;
                const userList = document.getElementById('accessList');
                const adminList = document.getElementById('adminAccessList');
                const countElement = document.getElementById('authorizedCount');

                if (countElement) {
                    countElement.textContent = accessList.length;
                }

                if (accessList.length === 0) {
                    const emptyHtml = '<p>No authorized users yet</p>';
                    if (userList) userList.innerHTML = emptyHtml;
                    if (adminList) adminList.innerHTML = emptyHtml;
                    return;
                }

                let html = '';
                accessList.forEach(user => {
                    const shortAddress = user.substring(0, 6) + '...' + user.substring(38);
                    html += `
                        <div class="access-item">
                            <span title="${user}">${shortAddress}</span>
                            <button onclick="admin.removeUserFromAccessList('${user}')" 
                                    style="background: #b21f1f; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem;">
                                    Remove
                            </button>
                        </div>
                    `;
                });
                
                if (userList) userList.innerHTML = html;
                if (adminList) adminList.innerHTML = html;
            }

            isUserAuthorized(userAddress) {
                // For demo - always authorize
                return true;
            }
        }

        const admin = new SimpleAdmin();

        // Update UI function
        function updateUI() {
            const accessStatus = document.getElementById('accessStatus');
            const mintBtn = document.getElementById('mintPass');
            const claimBtn = document.getElementById('claimBadge');
            const startARBtn = document.getElementById('startAR');
            const collection = document.getElementById('collection');
            const arPlaceholder = document.getElementById('arPlaceholder');

            if (!walletConnected) {
                accessStatus.className = 'status locked';
                accessStatus.textContent = 'AR Content Locked - Connect Wallet';
                if (mintBtn) mintBtn.disabled = true;
                if (claimBtn) claimBtn.disabled = true;
                if (startARBtn) startARBtn.disabled = true;
                if (collection) collection.innerHTML = '<p>Connect your wallet to view your passes and badges</p>';
                if (arPlaceholder) {
                    arPlaceholder.innerHTML = `
                        <div style="text-align: center;">
                            <h3>üîí AR Scanner</h3>
                            <p>Complete these steps to unlock:</p>
                            <div style="margin: 15px 0;">
                                <p style="color: #b21f1f;">‚úó Connect Wallet</p>
                                <p style="color: #b21f1f;">‚úó Mint Pass</p>
                                <p style="color: #b21f1f;">‚úó Claim Badge</p>
                            </div>
                            <p style="color: #fdbb2d;">Connect wallet to begin</p>
                        </div>
                    `;
                }
                return;
            }

            if (hasPass) {
                accessStatus.className = 'status unlocked';
                const mode = usingRealBlockchain ? 'Real Blockchain' : 'Simulation';
                accessStatus.textContent = `AR Content Unlocked - ${mode}`;
                
                if (mintBtn) mintBtn.disabled = true;
                if (claimBtn) claimBtn.disabled = false;
                
                if (arPlaceholder && !arActive) {
                    arPlaceholder.innerHTML = `
                        <div style="text-align: center;">
                            <h3>üîì AR Scanner Ready</h3>
                            <p>Complete these steps:</p>
                            <div style="margin: 15px 0;">
                                <p style="color: #00ff00;">‚úì Connect Wallet</p>
                                <p style="color: #00ff00;">‚úì Mint Pass</p>
                                <p style="color: ${hasBadge ? '#00ff00' : '#b21f1f'};">${hasBadge ? '‚úì' : '‚úó'} Claim Badge</p>
                            </div>
                            ${hasBadge ? 
                                '<p style="color: #fdbb2d; margin-top: 10px;">üéâ Click "Start AR Scanner" to begin!</p>' : 
                                '<p style="color: #fdbb2d;">Claim your badge to unlock AR</p>'
                            }
                        </div>
                    `;
                }
                
                if (startARBtn) startARBtn.disabled = !hasBadge;
                
            } else {
                accessStatus.className = 'status locked';
                accessStatus.textContent = 'Connect Wallet & Mint Pass';
                if (mintBtn) mintBtn.disabled = false;
                if (claimBtn) claimBtn.disabled = true;
                if (startARBtn) startARBtn.disabled = true;
            }

            // Update collection
            if (collection) {
                let items = [];
                if (hasPass) items.push('Access Pass');
                if (hasBadge) items.push('AR Badge');
                collection.innerHTML = items.length ? 
                    items.map(item => `<div class="badge">${item}</div>`).join('') : 
                    '<p>No items yet</p>';
            }

            analytics.updateLiveStats();
        }

        // Wallet connection
        // Wallet connection - UPDATED
async function connectWallet() {
    try {
        if (typeof window.ethereum !== 'undefined') {
            console.log("üîó MetaMask detected");
            const accounts = await window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });
            
            currentUserAddress = accounts[0];
            walletConnected = true;
            
            console.log("‚úÖ Connected:", currentUserAddress);
            
            // Try to initialize contracts for real blockchain
            try {
                await contractManager.initialize();
                
                // Check user's blockchain status
                const status = await contractManager.checkUserStatus(currentUserAddress);
                hasPass = status.hasPass;
                hasBadge = status.hasBadge;
                
                console.log("Blockchain status:", status);
                
                if (hasPass) {
                    usingRealBlockchain = true;
                    document.getElementById('accessStatus').innerHTML = 
                        `‚úÖ Blockchain Connected<br>Passes: ${status.passCount} | Badge: ${hasBadge ? 'Yes' : 'No'}`;
                }
                
            } catch (contractError) {
                console.warn("Contract initialization failed, using simulation:", contractError);
                usingRealBlockchain = false;
            }
            
            // Admin check
            if (admin.isAdmin(currentUserAddress)) {
                admin.showAdminPanel();
                console.log("üëë Admin detected");
            }
            
            analytics.setCurrentUser(currentUserAddress);
            analytics.trackEvent('wallet_connected', {
                hasPass: hasPass,
                hasBadge: hasBadge,
                blockchain: usingRealBlockchain
            });
            
            updateUI();
            
        } else {
            // Fallback to simulation
            console.log("üé≠ Using simulation mode");
            currentUserAddress = '0xSimulatedUser' + Math.random().toString(16).substr(2, 6);
            walletConnected = true;
            usingRealBlockchain = false;
            
            analytics.setCurrentUser(currentUserAddress);
            analytics.trackEvent('wallet_connected', { simulated: true });
            updateUI();
        }
    } catch (error) {
        console.error('Connection failed:', error);
        alert('Wallet connection failed: ' + error.message);
    }
}

       // Mint pass function - UPDATED FOR REAL BLOCKCHAIN
async function mintPass() {
    if (!walletConnected) {
        alert('Please connect wallet first');
        return;
    }

    const accessStatus = document.getElementById('accessStatus');
    const mintBtn = document.getElementById('mintPass');
    
    accessStatus.textContent = 'Minting Pass...';
    accessStatus.className = 'status locked';
    mintBtn.disabled = true;
    mintBtn.textContent = 'Minting...';

    try {
        let success = false;
        
        if (usingRealBlockchain && window.ethereum) {
            // REAL BLOCKCHAIN MINTING
            success = await mintPassOnBlockchain();
        } else {
            // SIMULATION MINTING (fallback)
            success = await simulateMintPass();
        }

        if (success) {
            hasPass = true;
            analytics.trackEvent('pass_minted', {
                user: currentUserAddress,
                blockchain: usingRealBlockchain ? 'real' : 'simulated'
            });
            
            updateUI();
            
            accessStatus.className = 'status unlocked';
            accessStatus.textContent = 'üéâ Pass Minted! AR Unlocked.';
            alert('üéâ Pass minted successfully! You can now claim your badge.');
            
        } else {
            throw new Error('Minting failed');
        }

    } catch (error) {
        console.error('Minting error:', error);
        
        accessStatus.textContent = 'Minting Failed - Try Simulation';
        accessStatus.className = 'status locked';
        
        // Offer simulation as fallback
        if (confirm('Blockchain minting failed. Use simulation mode?')) {
            usingRealBlockchain = false;
            success = await simulateMintPass();
            if (success) {
                hasPass = true;
                analytics.trackEvent('pass_minted', { simulated: true });
                updateUI();
                accessStatus.className = 'status unlocked';
                accessStatus.textContent = 'üéâ Pass Minted (Simulation)!';
            }
        }
        
    } finally {
        mintBtn.disabled = false;
        mintBtn.textContent = 'Mint Pass';
        updateUI();
    }
}

// REAL BLOCKCHAIN MINTING FUNCTION
async function mintPassOnBlockchain() {
    console.log('üîó Starting real blockchain mint...');
    
    try {
        // Initialize contract manager if not done
        if (!contractManager.initialized) {
            const initialized = await contractManager.initialize();
            if (!initialized) {
                throw new Error("Failed to initialize contracts");
            }
        }
        
        // Check current status first
        const status = await contractManager.checkUserStatus(currentUserAddress);
        if (status.hasPass) {
            alert('You already have a pass!');
            hasPass = true;
            updateUI();
            return true;
        }
        
        // Check minting status
        const mintingEnabled = await contractManager.passContract.mintingEnabled();
        if (!mintingEnabled) {
            throw new Error('Minting is currently disabled');
        }
        
        // Get mint price from contract
        const mintPrice = await contractManager.passContract.MINT_PRICE();
        
        // Show confirmation with price
        const ethPrice = ethers.utils.formatEther(mintPrice);
        const confirmed = confirm(`Mint pass for ${ethPrice} ETH?\n\nYou need Sepolia ETH from a faucet.`);
        if (!confirmed) return false;
        
        // Execute mint transaction
        document.getElementById('accessStatus').textContent = '‚è≥ Sending transaction...';
        
        const tx = await contractManager.passContract.mintPass({
            value: mintPrice,
            gasLimit: 300000
        });
        
        console.log('Transaction sent:', tx.hash);
        
        // Add link to explorer
        const explorerLink = `https://sepolia.etherscan.io/tx/${tx.hash}`;
        document.getElementById('accessStatus').innerHTML = 
            `‚è≥ Processing... <a href="${explorerLink}" target="_blank" style="color: #fdbb2d;">View on Etherscan</a>`;
        
        // Wait for confirmation
        document.getElementById('accessStatus').textContent = '‚è≥ Waiting for confirmation...';
        const receipt = await tx.wait();
        console.log('Transaction confirmed:', receipt);
        
        // Verify mint was successful
        const newStatus = await contractManager.checkUserStatus(currentUserAddress);
        if (newStatus.hasPass) {
            console.log('‚úÖ Pass minted successfully!');
            return true;
        } else {
            throw new Error('Mint succeeded but pass not found');
        }
        
    } catch (error) {
        console.error('Blockchain mint error:', error);
        
        // User-friendly error messages
        let errorMessage = 'Minting failed: ';
        
        if (error.code === 'INSUFFICIENT_FUNDS') {
            errorMessage += 'Insufficient ETH for transaction. Get Sepolia ETH from a faucet.';
        } else if (error.code === 'ACTION_REJECTED') {
            errorMessage += 'Transaction rejected by user.';
        } else if (error.message.includes('Already minted')) {
            errorMessage += 'You already have a pass.';
        } else if (error.message.includes('minting disabled')) {
            errorMessage += 'Minting is currently disabled.';
        } else if (error.message.includes('user rejected')) {
            errorMessage += 'User rejected the transaction.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        return false;
    }
}

// SIMULATION MINTING (keep this as fallback)
async function simulateMintPass() {
    console.log('üé≠ Simulating pass mint...');
    
    // Simulate delay for realism
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Store in localStorage to persist
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    userData[currentUserAddress] = {
        ...userData[currentUserAddress],
        hasPass: true,
        mintedAt: new Date().toISOString()
    };
    localStorage.setItem('user_data', JSON.stringify(userData));
    
    return true;
}
        // Claim badge function
        // Claim badge function - UPDATED FOR REAL BLOCKCHAIN
async function claimBadge() {
    if (!walletConnected || !hasPass) {
        alert('Need wallet connection and pass first');
        return;
    }

    const accessStatus = document.getElementById('accessStatus');
    const claimBtn = document.getElementById('claimBadge');
    
    accessStatus.textContent = 'Claiming Badge...';
    claimBtn.disabled = true;
    claimBtn.textContent = 'Claiming...';

    try {
        let success = false;
        
        if (usingRealBlockchain && window.ethereum) {
            success = await claimBadgeOnBlockchain();
        } else {
            success = await simulateClaimBadge();
        }

        if (success) {
            hasBadge = true;
            analytics.trackEvent('badge_claimed');
            analytics.trackEvent('ar_accessed');
            
            updateUI();
            
            accessStatus.textContent = 'üèÜ Badge Claimed! AR Scanner Ready.';
            alert('üèÜ Badge claimed successfully! You can now scan the Hiro marker.');
            
        } else {
            throw new Error('Badge claim failed');
        }

    } catch (error) {
        console.error('Badge claim error:', error);
        alert('Badge claim failed: ' + error.message);
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim Badge';
    }
}

// REAL BLOCKCHAIN BADGE CLAIM
async function claimBadgeOnBlockchain() {
    console.log('üîó Claiming badge on blockchain...');
    
    try {
        if (!contractManager.initialized) {
            await contractManager.initialize();
        }
        
        // Check if already has badge
        const status = await contractManager.checkUserStatus(currentUserAddress);
        if (status.hasBadge) {
            alert('You already have a badge!');
            hasBadge = true;
            updateUI();
            return true;
        }
        
        // Check if has pass
        if (!status.hasPass) {
            throw new Error('You need to mint a pass first');
        }
        
        // Show confirmation
        const confirmed = confirm('Claim your AR Experience Badge?\n\nThis will mint a free NFT badge.');
        if (!confirmed) return false;
        
        // Execute claim transaction
        document.getElementById('accessStatus').textContent = '‚è≥ Claiming badge...';
        
        const tx = await contractManager.badgeContract.claimBadge({
            gasLimit: 200000
        });
        
        console.log('Claim transaction sent:', tx.hash);
        
        // Add explorer link
        const explorerLink = `https://sepolia.etherscan.io/tx/${tx.hash}`;
        document.getElementById('accessStatus').innerHTML = 
            `‚è≥ Processing badge claim... <a href="${explorerLink}" target="_blank" style="color: #fdbb2d;">View on Etherscan</a>`;
        
        // Wait for confirmation
        const receipt = await tx.wait();
        console.log('Badge claim confirmed:', receipt);
        
        // Verify badge was minted
        const newStatus = await contractManager.checkUserStatus(currentUserAddress);
        if (newStatus.hasBadge) {
            console.log('‚úÖ Badge claimed successfully!');
            return true;
        } else {
            throw new Error('Claim succeeded but badge not found');
        }
        
    } catch (error) {
        console.error('Badge claim error:', error);
        
        let errorMessage = 'Badge claim failed: ';
        
        if (error.message.includes('Need access pass first')) {
            errorMessage += 'You need to mint a pass first.';
        } else if (error.message.includes('Already claimed')) {
            errorMessage += 'You already have a badge.';
        } else if (error.code === 'ACTION_REJECTED') {
            errorMessage += 'Transaction rejected.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        return false;
    }
}

// SIMULATION BADGE CLAIM (fallback)
async function simulateClaimBadge() {
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    userData[currentUserAddress] = {
        ...userData[currentUserAddress],
        hasBadge: true,
        claimedAt: new Date().toISOString()
    };
    localStorage.setItem('user_data', JSON.stringify(userData));
    
    return true;
}

        // Start AR Scanner
        async function startARScanner() {
            if (!hasBadge) {
                alert('Please claim your badge first to unlock AR scanning.');
                return;
            }
            
            const hasCamera = await arManager.checkCameraPermission();
            if (hasCamera) {
                arManager.createARScene();
                updateUI();
                analytics.trackEvent('ar_scanner_started');
            }
        }

        // Stop AR Scanner
        function stopARScanner() {
            arManager.stopARScene();
            updateUI();
        }

        // Emergency functions
        function forceAdminUnlock() {
            console.log("üö® FORCE ADMIN UNLOCK ACTIVATED");
            
            walletConnected = true;
            hasPass = true;
            hasBadge = true;
            currentUserAddress = currentUserAddress || '0xAdminUser';
            
            admin.showAdminPanel();
            updateUI();
            
            document.getElementById('accessStatus').className = 'status unlocked';
            document.getElementById('accessStatus').innerHTML = 'üéØ <strong>ADMIN OVERRIDE</strong> - Full Access Granted';
            
            alert('üö® ADMIN OVERRIDE: Full access granted!');
        }

        function forceRealBlockchain() {
    console.log("üöÄ FORCING REAL BLOCKCHAIN MODE");
    
    usingRealBlockchain = true;
    updateUI();
    
    // Try to initialize contracts
    contractManager.initialize().then(success => {
        if (success) {
            document.getElementById('accessStatus').textContent = '‚úÖ Real Blockchain Mode Activated!';
            alert('üöÄ Real blockchain mode activated!\n\nMake sure you have:\n1. Contract addresses configured\n2. Sepolia ETH for gas\n3. MetaMask on Sepolia network');
        } else {
            document.getElementById('accessStatus').textContent = '‚ùå Failed to initialize blockchain';
            alert('Failed to initialize blockchain. Check contract configuration.');
        }
    });
}

        function debugAdminStatus() {
            const debugInfo = document.getElementById('adminDebugInfo');
            const debugHTML = `
                <strong>Debug Information:</strong><br>
                ‚Ä¢ Current User: ${currentUserAddress || 'Not connected'}<br>
                ‚Ä¢ Is Admin: ${admin.isAdmin(currentUserAddress)}<br>
                ‚Ä¢ Wallet Connected: ${walletConnected}<br>
                ‚Ä¢ Has Pass: ${hasPass}<br>
                ‚Ä¢ Has Badge: ${hasBadge}<br>
                ‚Ä¢ AR Active: ${arActive}<br>
                ‚Ä¢ Using Real Blockchain: ${usingRealBlockchain}<br>
                ‚Ä¢ In Access List: ${admin.accessList.includes((currentUserAddress || '').toLowerCase())}
            `;
            debugInfo.innerHTML = debugHTML;
        }

        function resetLocalStorage() {
            if (confirm('‚ö†Ô∏è Reset ALL local data?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Analytics functions
        function showAnalytics() {
            document.getElementById('analyticsModal').style.display = 'block';
        }

        function closeAnalytics() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set up button listeners
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('mintPass').addEventListener('click', mintPass);
            document.getElementById('claimBadge').addEventListener('click', claimBadge);
            document.getElementById('startAR').addEventListener('click', startARScanner);
            document.getElementById('stopAR').addEventListener('click', stopARScanner);

            // Add network change listeners
window.ethereum?.on('chainChanged', (chainId) => {
    console.log('Network changed:', chainId);
    location.reload();
});

window.ethereum?.on('accountsChanged', (accounts) => {
    console.log('Account changed:', accounts);
    if (accounts.length === 0) {
        // User disconnected wallet
        walletConnected = false;
        currentUserAddress = null;
        hasPass = false;
        hasBadge = false;
    } else {
        currentUserAddress = accounts[0];
    }
    updateUI();
});
            
            // Admin buttons
            document.getElementById('forceAdminUnlock').addEventListener('click', forceAdminUnlock);
            document.getElementById('debugAdminStatus').addEventListener('click', debugAdminStatus);
            document.getElementById('resetAllData').addEventListener('click', resetLocalStorage);
            document.getElementById('forceRealBlockchain').addEventListener('click', forceRealBlockchain);
            
            // Access control buttons
            document.getElementById('addCurrentUser').addEventListener('click', function() {
                if (currentUserAddress) {
                    admin.addUserToAccessList(currentUserAddress);
                    alert('‚úÖ User added to access list!');
                } else {
                    alert('Please connect wallet first');
                }
            });
            
            document.getElementById('clearAccessList').addEventListener('click', function() {
                if (confirm('Clear access list?')) {
                    admin.clearAccessList();
                    alert('Access list cleared!');
                }
            });

            // Admin panel buttons
            document.getElementById('addCurrentUserAdmin').addEventListener('click', function() {
                if (currentUserAddress) {
                    admin.addUserToAccessList(currentUserAddress);
                } else {
                    alert('Please connect wallet first');
                }
            });

            document.getElementById('addDemoUsers').addEventListener('click', function() {
                const demoUsers = [
                    '0x05130FAC6F9AA13fFeC3789bd8ff2E065539F9C2',
                    '0x9fC8c0A838a95c2A1A07ac417336b852b6A49e72',
                ];
                demoUsers.forEach(user => admin.addUserToAccessList(user));
                alert('‚úÖ Demo users added!');
            });

            document.getElementById('clearAccessListAdmin').addEventListener('click', function() {
                if (confirm('Clear all access?')) {
                    admin.clearAccessList();
                }
            });

            document.getElementById('addUserByAddress').addEventListener('click', function() {
                const address = document.getElementById('userAddressInput').value.trim();
                if (address) {
                    admin.addUserToAccessList(address);
                    document.getElementById('userAddressInput').value = '';
                } else {
                    alert('Please enter an address');
                }
            });

            // Analytics buttons
            document.getElementById('showAnalytics').addEventListener('click', showAnalytics);
            document.getElementById('adminAnalyticsBtn').addEventListener('click', showAnalytics);
            document.getElementById('closeAnalytics').addEventListener('click', closeAnalytics);
            document.getElementById('showAdminAnalytics').addEventListener('click', showAnalytics);
           
            const refreshBtn = document.getElementById('refreshAnalytics');
            const exportBtn = document.getElementById('exportAnalytics');
            const clearBtn = document.getElementById('clearAnalytics');
    
            if (refreshBtn) {
                 refreshBtn.addEventListener('click', function() {
                    console.log('Refresh analytics clicked');
                    analytics.updateLiveStats();
                    analytics.updateTimeline();
                    analytics.updateUserActivity();
                    alert('‚úÖ Analytics refreshed!');
                });
            } else {
                 console.error('refreshAnalytics button not found');
            }

            if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            console.log('Export analytics clicked');
            
            const exportData = {
                events: analytics.events,
                stats: analytics.stats,
                generatedAt: new Date().toISOString(),
                totalEvents: analytics.events.length,
                uniqueUsers: analytics.stats.uniqueUsers
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `web3-analytics-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('üì• Analytics data exported!');
        });
    } else {
        console.error('exportAnalytics button not found');
    }
     if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            console.log('Clear analytics clicked');
            
            if (confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL analytics data!\n\n‚Ä¢ Event history\n‚Ä¢ User statistics\n‚Ä¢ Timeline data\n\nAre you sure?')) {
                // Reset analytics
                analytics.events = [];
                analytics.stats = {
                    passesMinted: 0,
                    arAccesses: 0,
                    uniqueUsers: 0,
                    badgesClaimed: 0
                };
                
                // Clear localStorage
                localStorage.removeItem('ar_analytics_events');
                localStorage.removeItem('ar_analytics_stats');
                  // Update displays
                analytics.updateLiveStats();
                analytics.updateTimeline();
                analytics.updateUserActivity();
                
                alert('‚úÖ All analytics data cleared!');
            }
        });
    } else {
        console.error('clearAnalytics button not found');
    }
    
    // Close modal when clicking outside
    document.getElementById('analyticsModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeAnalytics();
        }
    });
            // Add CSS animation for spinner
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);

            // Initialize
            admin.updateAccessListDisplay();
            analytics.updateLiveStats();
            updateUI();

            console.log("‚úÖ WebAR System with Hiro Marker Initialized Successfully!");
        });

        // Make admin global for remove buttons
        window.admin = admin;
        window.arManager = arManager;
    </script>
</body>
</html>

